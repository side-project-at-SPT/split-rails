name: Push Change to Discord Webhook URL

on:
  push:
    branches:
      - main
      - 'tmp/receive-commit-to-trigger-GHA'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  send-to-discord-webhook-url:
    runs-on: ubuntu-latest
    steps:
    - name: crawl-commit-message-headers
      id: crawl-commit-message-headers
      uses: actions/github-script@v7
      with:
        script: |
          const commitMessage = context.payload.head_commit.message;
          const commitMessageHeaders = commitMessage.split('\n')[0];
          console.log(commitMessageHeaders);
          core.exportVariable('commitMessageHeaders', commitMessageHeaders);
    - name: build-discord-webhook-payload
      id: build-discord-webhook-payload
      uses: actions/github-script@v7
      env:
        # DISCORD_WEBHOOK_URL: ${{ secrets.SANDBOX_DISCORD_WEBHOOK_URL }}
        DISCORD_WEBHOOK_URL: ${{ secrets.SPLIT_GAME_CHANNEL_DISCORD_WEBHOOK_URL }}
      with:
        script: |
          const { commitMessageHeaders } = process.env;
          const discordWebhookPayload = {
            content: commitMessageHeaders,
            username: 'GitHub Actions',
            avatar_url: 'https://media.discordapp.net/attachments/808663045109710898/1277146864906407988/image.png?ex=66ce1574&is=66ccc3f4&hm=f8dbff1de3b493dcdd0c8844a848efaa3c36b7296466d6709b9fe1c610561fa5&=&format=webp&quality=lossless'
          };
          const req = new Request(process.env.DISCORD_WEBHOOK_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(discordWebhookPayload)
          });
          const res = await fetch(req);
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
